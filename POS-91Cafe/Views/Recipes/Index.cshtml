@model IEnumerable<POS_91Cafe.Models.Product>
@{
    ViewData["Title"] = "Recipe Management";
    // We intentionally ignore any previous category selection to show ALL items on load.
    var categories = ViewBag.AllCategories as IEnumerable<string> ?? Enumerable.Empty<string>();
}

<div class="container-fluid py-4">
    <div class="row g-4 mb-4 align-items-end">
        <div class="col-md-6">
            <h2 class="fw-bold mb-1" style="color: var(--brand-dark);">Recipe Management</h2>
            <p class="text-muted mb-0">Configure ingredients for automated stock deduction.</p>
        </div>
        <div class="col-md-6">
            <div class="d-flex gap-3 justify-content-md-end">
                <div class="bg-white border rounded-3 px-3 py-2 shadow-sm d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-light p-2 text-secondary"><i class="fas fa-layer-group"></i></div>
                    <div>
                        <small class="text-muted d-block" style="font-size:0.7rem;line-height:1;">TOTAL</small>
                        <span class="fw-bold text-dark">@Model.Count()</span>
                    </div>
                </div>
                <div class="bg-white border rounded-3 px-3 py-2 shadow-sm d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-success bg-opacity-10 p-2 text-success"><i class="fas fa-check"></i></div>
                    <div>
                        <small class="text-muted d-block" style="font-size:0.7rem;line-height:1;">CONFIGURED</small>
                        <span class="fw-bold text-success">@Model.Count(p => p.ProductIngredients.Any())</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4" style="border-radius:16px;">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="recipeSearch" class="form-control border-start-0" placeholder="Search products...">
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="categoryFilter" class="form-select">
                        <option value="All" selected="selected">All Categories</option>
                        @foreach (var cat in categories)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <select id="statusFilter" class="form-select">
                        <option value="All" selected="selected">All Statuses</option>
                        <option value="Configured">Configured (Has Recipe)</option>
                        <option value="Unconfigured">Unconfigured (Needs Attention)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Grid -->
    <div id="recipeGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
        @foreach (var product in Model.OrderBy(p => p.Name))
        {
            var hasRecipe = product.ProductIngredients.Any();
            var status = hasRecipe ? "Configured" : "Unconfigured";
            var category = product.Category?.Name ?? "Uncategorized";
            var ingredientCount = product.ProductIngredients.Count;

            <div class="col recipe-card-wrapper"
                 data-name="@product.Name.ToLower()"
                 data-category="@category"
                 data-status="@status">

                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge bg-light text-secondary border">@category</span>
                            @if (hasRecipe)
                            {
                                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill">
                                    <i class="fas fa-check-circle me-1"></i> Configured
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 rounded-pill">
                                    <i class="fas fa-exclamation-circle me-1"></i> No Recipe
                                </span>
                            }
                        </div>

                        <h5 class="fw-bold text-dark mb-1 text-truncate">@product.Name</h5>
                        <div class="mb-4">
                            @if (hasRecipe)
                            {
                                <small class="text-muted"><i class="fas fa-cubes me-1"></i> @ingredientCount ingredients linked</small>
                            }
                            else
                            {
                                <small class="text-danger opacity-75"><i class="fas fa-times me-1"></i> Stock won't auto-deduct</small>
                            }
                        </div>

                        <div class="mt-auto pt-3 border-top">
                            <a href="@Url.Action("Manage","Recipes", new { id = product.ProductID })"
                               class="btn w-100 manage-link @(hasRecipe ? "btn-outline-secondary" : "btn-primary")"
                               style="border-radius:10px;">
                                <i class="fas fa-sliders-h me-2"></i>Manage Recipe
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div id="emptyState" class="text-center py-5" style="display:none;">
        <div class="opacity-25 mb-3 text-muted"><i class="fas fa-filter fa-4x"></i></div>
        <h5 class="text-muted fw-bold">No recipes found</h5>
        <p class="text-secondary">Try adjusting your filters.</p>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput  = document.getElementById('recipeSearch');
            const catFilter    = document.getElementById('categoryFilter');
            const statusFilter = document.getElementById('statusFilter');
            const gridItems    = document.querySelectorAll('.recipe-card-wrapper');
            const emptyState   = document.getElementById('emptyState');

            function norm(s){ return (s||'').trim().toLowerCase(); }

            function filterGrid() {
                const term = norm(searchInput.value);
                const cat  = norm(catFilter.value);
                const stat = norm(statusFilter.value);
                let visible = 0;

                gridItems.forEach(item => {
                    const nm = norm(item.dataset.name);
                    const ic = norm(item.dataset.category);
                    const st = norm(item.dataset.status);

                    const okTerm  = !term || nm.includes(term);
                    const okCat   = cat === 'all' || ic === cat;
                    const okStatus= stat === 'all' || st === stat;

                    if (okTerm && okCat && okStatus) {
                        item.style.display = '';
                        visible++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                emptyState.style.display = visible === 0 ? 'block' : 'none';
            }

            searchInput.addEventListener('input', filterGrid);
            catFilter.addEventListener('change', filterGrid);
            statusFilter.addEventListener('change', filterGrid);

            // Initial (ALL visible)
            filterGrid();

            // Navigation to Manage without altering URL (no category persistence needed now)
            // If later you want to remember category just add code here.
        });
    </script>
}